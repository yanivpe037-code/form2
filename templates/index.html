<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×˜×•×¤×¡ 2 - ×¨×™×›×•×– ×ª×§×‘×•×œ×™× ×•×ª×©×œ×•××™×</title>
  <style>
    html { font-size: 150%; }
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f0f4f8;
      color: #1a202c;
      direction: rtl;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .site-header {
      background: linear-gradient(135deg, #1e3a8a 0%, #1d4ed8 100%);
      color: #fff;
      padding: 18px 32px;
      display: flex;
      align-items: center;
      gap: 24px;
      flex-wrap: wrap;
    }
    .site-header h1 { font-size: 1.4rem; font-weight: 700; white-space: nowrap; }
    .site-header .subtitle { font-size: 0.85rem; opacity: 0.75; white-space: nowrap; }
    .selector-wrap { display: flex; align-items: center; gap: 10px; margin-right: auto; }
    .selector-wrap label { font-size: 0.9rem; font-weight: 600; white-space: nowrap; }
    .muni-selector { display: flex; align-items: center; gap: 6px; }
    #muni-search {
      font-family: inherit; font-size: 0.9rem; padding: 7px 10px;
      border: none; border-radius: 6px 0 0 6px; width: 140px;
      background: #dbeafe; color: #1e3a8a; font-weight: 500; direction: rtl;
      outline: none;
    }
    #muni-search::placeholder { color: #93c5fd; }
    #muni-select {
      font-family: inherit; font-size: 0.95rem; padding: 7px 10px;
      border: none; border-radius: 0 6px 6px 0; min-width: 220px;
      background: #fff; color: #1e3a8a; font-weight: 700; direction: rtl;
      cursor: pointer; outline: none;
    }

    /* â”€â”€ Main area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    main { padding: 24px 16px; }

    #placeholder {
      text-align: center; padding: 60px 20px;
      color: #64748b; font-size: 1.1rem;
    }
    #loading {
      display: none; text-align: center; padding: 40px;
      color: #1d4ed8; font-size: 1rem;
    }
    .spinner {
      display: inline-block; width: 28px; height: 28px;
      border: 3px solid #bfdbfe; border-top-color: #1d4ed8;
      border-radius: 50%; animation: spin 0.8s linear infinite;
      vertical-align: middle; margin-left: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #report { display: none; }
    .report-title { text-align: center; margin-bottom: 18px; }
    .report-title h2 { font-size: 1.3rem; color: #1e3a8a; font-weight: 800; }
    .report-title p { font-size: 0.8rem; color: #64748b; margin-top: 4px; }

    /* Two panels side by side */
    .panels { display: flex; gap: 16px; align-items: flex-start; }
    .panel {
      flex: 1; min-width: 0; background: #fff;
      border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); overflow: hidden;
    }
    .panel-header { padding: 12px 16px; font-size: 1rem; font-weight: 700; color: #fff; }
    .panel-receipts .panel-header { background: #1d4ed8; }
    .panel-payments .panel-header { background: #0f766e; }

    /* â”€â”€ Column group separators â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .th-group-sep { border-right: 2px solid #cbd5e1 !important; }
    td.td-group-sep { border-right: 2px solid #e2e8f0; }

    /* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    table { width: 100%; border-collapse: collapse; font-size: 0.78rem; direction: rtl; }

    /* Sub-header row for column groups */
    thead tr.th-group th {
      background: #f1f5f9; font-size: 0.68rem; font-weight: 700;
      color: #64748b; padding: 4px 6px; text-align: center;
      border-bottom: 1px solid #e2e8f0; text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    thead tr.th-cols th {
      padding: 7px 6px; text-align: center; background: #f8fafc;
      border-bottom: 2px solid #e2e8f0; font-weight: 700;
      font-size: 0.72rem; color: #374151; white-space: nowrap;
    }
    thead th.th-label { text-align: right; }
    thead th.th-num  { width: 28px; color: #94a3b8; }

    tbody tr:hover { background: #f0f9ff; }
    td { padding: 5px 6px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
    td.td-num   { color: #94a3b8; font-size: 0.68rem; text-align: center; width: 28px; }
    td.td-label { text-align: right; padding-right: 10px; }
    td.td-val   { text-align: left; font-variant-numeric: tabular-nums; white-space: nowrap; padding-left: 8px; }
    td.td-pct   { text-align: center; font-size: 0.7rem; color: #6b7280; white-space: nowrap; width: 42px; }
    td.td-stat  { text-align: center; font-size: 0.7rem; color: #7c3aed; white-space: nowrap; width: 46px; }
    td.td-rank  { text-align: center; font-size: 0.72rem; font-weight: 700; white-space: nowrap; width: 40px; }

    /* rank badge colours */
    .rank-top    { color: #b45309; }   /* gold   â€“ top 10% */
    .rank-high   { color: #166534; }   /* green  â€“ top 25% */
    .rank-mid    { color: #1d4ed8; }   /* blue   â€“ top 50% */
    .rank-low    { color: #6b7280; }   /* gray   â€“ bottom 50% */

    td.zero     { color: #d1d5db; }
    td.negative { color: #dc2626; }

    /* â”€â”€ Row types â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    tr.row-section_header td {
      background: #eff6ff; font-weight: 800; font-size: 0.8rem;
      color: #1e40af; padding: 7px 10px; border-bottom: 1px solid #bfdbfe;
    }
    tr.row-section_header td.td-num { color: #93c5fd; font-size: 0.75rem; }

    tr.row-subtotal td {
      background: #f0fdf4; font-weight: 700; color: #166534;
      border-top: 1px solid #bbf7d0; border-bottom: 1px solid #bbf7d0;
    }
    tr.row-subtotal td.td-pct  { color: #16a34a; }
    tr.row-subtotal td.td-stat { color: #059669; }
    tr.row-subtotal td.td-num  { color: #86efac; }

    tr.row-irregular td {
      background: #fffbeb; font-weight: 600; color: #92400e;
      border-top: 1px solid #fde68a;
    }
    tr.row-irregular td.td-pct  { color: #d97706; }
    tr.row-irregular td.td-stat { color: #b45309; }

    /* â”€â”€ Sub-rows (children of a parent row) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* Parent row that has sub_row children */
    tr.has-children td {
      border-bottom: none;
    }
    tr.has-children td.td-label::after {
      content: ' â–¾';
      font-size: 0.65rem;
      color: #dc2626;
      vertical-align: middle;
    }

    /* Sub-row itself */
    tr.row-sub_row td {
      background: #fff5f5;
      border-right: 3px solid #dc2626;
      border-bottom: 1px solid #fecaca;
      font-size: 0.74rem;
    }
    tr.row-sub_row:last-of-type td,
    tr.row-sub_row + tr:not(.row-sub_row) {
      /* last sub-row gets a closing bottom border */
    }
    tr.row-sub_row td.td-label {
      padding-right: 26px;
      color: #991b1b;
      font-style: italic;
    }
    tr.row-sub_row td.td-label::before {
      content: 'â†³ ';
      color: #dc2626;
      font-style: normal;
      font-weight: 700;
    }
    tr.row-sub_row td.td-num  { color: #fca5a5; }
    tr.row-sub_row td.td-val  { color: #7f1d1d; }
    tr.row-sub_row td.td-pct  { color: #b91c1c; }
    tr.row-sub_row td.td-stat { color: #b91c1c; }
    tr.row-sub_row td.td-rank { color: #b91c1c; }
    tr.row-sub_row td.zero    { color: #fca5a5; }

    tr.row-grand_total td {
      background: #1e3a8a; color: #fff; font-weight: 800;
      font-size: 0.82rem; border-top: 2px solid #1e40af;
    }
    tr.row-grand_total td.td-pct  { color: #bfdbfe; }
    tr.row-grand_total td.td-stat { color: #bfdbfe; }
    tr.row-grand_total td.zero    { color: #6b7280; }

    .panel-payments tr.row-grand_total td { background: #0f766e; }
    .panel-payments tr.row-grand_total td.td-pct  { color: #99f6e4; }
    .panel-payments tr.row-grand_total td.td-stat { color: #99f6e4; }

    @media (max-width: 900px) { .panels { flex-direction: column; } }

    /* â”€â”€ Balance summary bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #balance-bar {
      margin-top: 14px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    #balance-bar table {
      width: 100%; border-collapse: collapse;
      font-size: 0.82rem; direction: rtl;
    }
    #balance-bar thead th {
      background: #1e293b; color: #cbd5e1;
      padding: 8px 16px; font-weight: 700;
      font-size: 0.72rem; text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    #balance-bar thead th.bal-label { text-align: right; width: 220px; }
    #balance-bar thead th.bal-num   { text-align: left;  min-width: 160px; }
    #balance-bar tbody td {
      padding: 9px 16px; border-bottom: 1px solid #f1f5f9;
      vertical-align: middle;
    }
    #balance-bar tbody td.bal-label {
      font-weight: 600; color: #334155;
    }
    #balance-bar tbody td.bal-num {
      text-align: left; font-variant-numeric: tabular-nums;
      white-space: nowrap; color: #0f172a; font-weight: 500;
      direction: ltr;   /* keep minus sign on the left */
    }
    #balance-bar tr.bal-divider td {
      border-top: 2px solid #e2e8f0; background: #f8fafc;
    }
    #balance-bar tr.bal-result td {
      background: #f0fdf4; border-top: 2px solid #bbf7d0;
      font-weight: 800; font-size: 0.88rem;
      border-bottom: none;
    }
    #balance-bar tr.bal-result td.bal-label { color: #166534; }
    #balance-bar tr.bal-deficit td {
      background: #fff1f2; border-top: 2px solid #fecdd3;
      font-weight: 800; font-size: 0.88rem;
      border-bottom: none;
    }
    #balance-bar tr.bal-deficit td.bal-label { color: #9f1239; }
    /* per-cell sign colours (set via JS) */
    .bal-positive { color: #15803d !important; }
    .bal-negative { color: #dc2626 !important; }

    /* â”€â”€ Clickable rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    tr.row-clickable { cursor: pointer; }
    tr.row-clickable:hover td { filter: brightness(0.94); }

    /* â”€â”€ Top/Bottom modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #tb-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(15,23,42,0.55); z-index: 2000; backdrop-filter: blur(2px);
    }
    #tb-overlay.open { display: block; }
    #tb-modal {
      display: none; position: fixed;
      top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #fff; border-radius: 14px; padding: 28px 30px 24px;
      min-width: 440px; max-width: 92vw; max-height: 88vh; overflow-y: auto;
      z-index: 2001; direction: rtl; box-shadow: 0 24px 64px rgba(0,0,0,0.28);
    }
    #tb-modal.open { display: block; }
    #tb-close {
      position: absolute; top: 14px; left: 16px;
      background: #f1f5f9; border: none; font-size: 1.1rem; cursor: pointer;
      color: #475569; padding: 4px 10px; border-radius: 6px; font-weight: 700;
    }
    #tb-close:hover { background: #e2e8f0; }
    #tb-title {
      font-size: 1.05rem; font-weight: 800; color: #1e3a8a;
      margin-bottom: 18px; padding-left: 40px; line-height: 1.4;
    }
    .tb-section { margin-bottom: 18px; }
    .tb-subtitle {
      font-size: 0.88rem; font-weight: 700; padding: 7px 12px;
      border-radius: 7px; margin-bottom: 10px; display: flex;
      align-items: center; gap: 8px;
    }
    .tb-top .tb-subtitle  { background: #fef9c3; color: #78350f; }
    .tb-bot .tb-subtitle  { background: #dcfce7; color: #14532d; }
    .tb-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    .tb-table th {
      background: #f8fafc; padding: 6px 10px; text-align: right;
      font-weight: 700; color: #374151; border-bottom: 2px solid #e2e8f0;
    }
    .tb-table td { padding: 8px 10px; border-bottom: 1px solid #f1f5f9; }
    .tb-table tr:last-child td { border-bottom: none; }
    .tb-table .td-r { text-align: center; color: #94a3b8; font-size: 0.78rem; width: 28px; }
    .tb-table .td-pct { text-align: center; font-weight: 700; color: #1d4ed8; width: 64px; }
    .tb-top .tb-table .td-pct { color: #b45309; }
    .tb-bot .tb-table .td-pct { color: #15803d; }
    .tb-footer {
      font-size: 0.72rem; color: #94a3b8; text-align: center; margin-top: 6px;
    }
    /* Zero-report section */
    .tb-zero-btn {
      display: inline-flex; align-items: center; gap: 6px;
      background: #f1f5f9; border: 1px solid #cbd5e1;
      color: #475569; font-size: 0.75rem; font-weight: 700;
      padding: 5px 12px; border-radius: 20px; cursor: pointer;
      margin-top: 10px; font-family: inherit;
      transition: background 0.15s, color 0.15s;
    }
    .tb-zero-btn:hover { background: #e2e8f0; color: #1e3a8a; border-color: #94a3b8; }
    .tb-zero-section {
      display: none; margin-top: 10px; padding: 10px 14px;
      background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;
    }
    .tb-zero-section.open { display: block; }
    .tb-zero-list {
      columns: 2; column-gap: 12px;
      font-size: 0.76rem; color: #374151;
      list-style: none; margin: 0; padding: 0;
    }
    .tb-zero-list li { padding: 3px 0; border-bottom: 1px solid #f1f5f9; break-inside: avoid; }
    .tb-zero-list li:last-child { border-bottom: none; }

    /* â”€â”€ Sheet selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #sheet-wrap { align-items: center; gap: 6px; }
    #sheet-wrap label { font-size: 0.9rem; font-weight: 600; white-space: nowrap; }
    #sheet-select {
      font-family: inherit; font-size: 0.88rem; padding: 7px 10px;
      border: none; border-radius: 6px; min-width: 200px;
      background: #e0e7ff; color: #1e3a8a; font-weight: 700;
      direction: rtl; cursor: pointer; outline: none;
    }
    .sheet-divider { color: rgba(255,255,255,0.35); font-size: 1.2rem; margin: 0 4px; }

    /* â”€â”€ Generic sheet table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #generic-view .panel-header { background: #4f46e5; }
    #generic-container { overflow-x: auto; }
    .gen-table { width: 100%; border-collapse: collapse; font-size: 0.78rem; direction: rtl; }
    .gen-table thead th {
      padding: 7px 8px; text-align: center;
      background: #f8fafc; border-bottom: 2px solid #e2e8f0;
      font-weight: 700; font-size: 0.7rem; color: #374151;
      white-space: nowrap;
    }
    .gen-table thead th.gen-th-label { text-align: right; min-width: 220px; padding-right: 10px; }
    .gen-table thead th.gen-th-num  { min-width: 100px; }
    .gen-table tbody td { padding: 5px 8px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
    .gen-table tbody td.gen-td-label { text-align: right; font-weight: 500; padding-right: 10px; }
    .gen-table tbody td.gen-td-num  {
      text-align: left; font-variant-numeric: tabular-nums;
      white-space: nowrap; direction: ltr; padding-left: 10px;
    }
    .gen-table tbody td.gen-td-null { color: #d1d5db; text-align: center; }
    .gen-table tbody tr:hover { background: #f0f9ff; }
    /* Subtotal */
    .gen-table tr.gen-subtotal td {
      background: #f0fdf4; font-weight: 700; color: #166534;
      border-top: 1px solid #bbf7d0; border-bottom: 1px solid #bbf7d0;
    }
    /* Result positive (×¢×•×“×£) */
    .gen-table tr.gen-result-pos td {
      background: #f0fdf4; font-weight: 800; color: #166534;
      border-top: 2px solid #bbf7d0; font-size: 0.82rem;
    }
    /* Result negative (×’×¨×¢×•×Ÿ) */
    .gen-table tr.gen-result-neg td {
      background: #fff1f2; font-weight: 800; color: #9f1239;
      border-top: 2px solid #fecdd3; font-size: 0.82rem;
    }
    /* Percentage / ratio rows */
    .gen-table tr.gen-pct-row td { font-size: 0.72rem; color: #6b7280; }
    /* Empty state */
    #generic-empty { text-align: center; padding: 40px; color: #94a3b8; font-size: 0.9rem; }
  </style>
</head>
<body>

<header class="site-header">
  <div>
    <h1>×˜×•×¤×¡ 2 â€” ×¨×™×›×•×– ×ª×§×‘×•×œ×™× ×•×ª×©×œ×•××™×</h1>
    <div class="subtitle">×ª×§×¦×™×‘ ×¨×’×™×œ ×œ×¤×™ ×¤×¨×§×™ ×”×ª×§×¦×™×‘ (××œ×¤×™ ×©"×—) | ×”×©×•×•××” ×œ×›×œ×œ ×”×¨×©×•×™×•×ª</div>
  </div>
  <div class="selector-wrap">
    <label for="muni-select">×‘×—×¨ ×¨×©×•×ª:</label>
    <div class="muni-selector">
      <input type="text" id="muni-search" placeholder="ğŸ” ×¡×™× ×•×Ÿ..." autocomplete="off" />
      <select id="muni-select">
        <option value="">â€” ×‘×—×¨ ×¨×©×•×ª â€”</option>
      </select>
    </div>
    <span class="sheet-divider" id="sheet-divider" style="display:none">|</span>
    <div id="sheet-wrap" style="display:none">
      <label for="sheet-select">×’×™×œ×™×•×Ÿ:</label>
      <select id="sheet-select"></select>
    </div>
  </div>
</header>

<main>
  <div id="placeholder">×‘×—×¨ ×¨×©×•×ª ××”×¨×©×™××” ×œ×”×¦×’×ª ×”× ×ª×•× ×™×</div>
  <div id="loading"><span class="spinner"></span> ×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>

  <div id="report">
    <div class="report-title">
      <h2 id="report-title-text"></h2>
      <p id="report-subtitle">× ×ª×•× ×™ ×‘×™×¦×•×¢ | ×©× ×ª ×“×•×— <span id="year-cur-label">â€”</span> | ×™×—×™×“×•×ª: ××œ×¤×™ ×©"×— | ×“×™×¨×•×’ ××ª×•×š <span id="n-munis">â€”</span> ×¨×©×•×™×•×ª</p>
    </div>

    <!-- â”€â”€ Form2 view (receipts + payments) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="form2-view">
    <div class="panels">
      <!-- RECEIPTS â€” right panel -->
      <div class="panel panel-receipts">
        <div class="panel-header">×ª×§×‘×•×œ×™×</div>
        <table id="tbl-receipts">
          <thead>
            <tr class="th-group">
              <th></th><th></th>
              <th colspan="2" class="th-group-sep">×‘×™×¦×•×¢ <span class="hdr-cur">â€”</span></th>
              <th colspan="2" class="th-group-sep">×‘×™×¦×•×¢ <span class="hdr-prev">â€”</span></th>
              <th colspan="3" class="th-group-sep">×”×©×•×•××” ×œ×›×œ×œ ×”×¨×©×•×™×•×ª (<span class="hdr-cur">â€”</span>)</th>
            </tr>
            <tr class="th-cols">
              <th class="th-num">#</th>
              <th class="th-label">×¡×¢×™×£</th>
              <th class="th-group-sep">×¡×›×•×</th><th>%</th>
              <th class="th-group-sep">×¡×›×•×</th><th>%</th>
              <th class="th-group-sep">×××•×¦×¢ %</th>
              <th>×—×¦×™×•×Ÿ %</th>
              <th>×“×™×¨×•×’</th>
            </tr>
          </thead>
          <tbody id="tbody-receipts"></tbody>
        </table>
      </div>

      <!-- PAYMENTS â€” left panel -->
      <div class="panel panel-payments">
        <div class="panel-header">×ª×©×œ×•××™×</div>
        <table id="tbl-payments">
          <thead>
            <tr class="th-group">
              <th></th><th></th>
              <th colspan="2" class="th-group-sep">×‘×™×¦×•×¢ <span class="hdr-cur">â€”</span></th>
              <th colspan="2" class="th-group-sep">×‘×™×¦×•×¢ <span class="hdr-prev">â€”</span></th>
              <th colspan="3" class="th-group-sep">×”×©×•×•××” ×œ×›×œ×œ ×”×¨×©×•×™×•×ª (<span class="hdr-cur">â€”</span>)</th>
            </tr>
            <tr class="th-cols">
              <th class="th-num">#</th>
              <th class="th-label">×¡×¢×™×£</th>
              <th class="th-group-sep">×¡×›×•×</th><th>%</th>
              <th class="th-group-sep">×¡×›×•×</th><th>%</th>
              <th class="th-group-sep">×××•×¦×¢ %</th>
              <th>×—×¦×™×•×Ÿ %</th>
              <th>×“×™×¨×•×’</th>
            </tr>
          </thead>
          <tbody id="tbody-payments"></tbody>
        </table>
      </div>
    </div>

    <!-- Balance summary -->
    <div id="balance-bar" style="display:none">
      <table>
        <thead>
          <tr>
            <th class="bal-label"></th>
            <th class="bal-num">×‘×™×¦×•×¢ <span class="hdr-cur">â€”</span></th>
            <th class="bal-num">×‘×™×¦×•×¢ <span class="hdr-prev">â€”</span></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="bal-label">×¡×”"×› ×ª×§×‘×•×œ×™×</td>
            <td class="bal-num" id="bal-rec-cur">â€”</td>
            <td class="bal-num" id="bal-rec-prev">â€”</td>
          </tr>
          <tr class="bal-divider">
            <td class="bal-label">×¡×”"×› ×ª×©×œ×•××™×</td>
            <td class="bal-num" id="bal-pay-cur">â€”</td>
            <td class="bal-num" id="bal-pay-prev">â€”</td>
          </tr>
          <tr id="bal-result-row">
            <td class="bal-label">×¢×•×“×£ (×’×¨×¢×•×Ÿ) ×©×•×˜×£</td>
            <td class="bal-num" id="bal-surplus-cur">â€”</td>
            <td class="bal-num" id="bal-surplus-prev">â€”</td>
          </tr>
        </tbody>
      </table>
    </div>
    </div><!-- /form2-view -->

    <!-- â”€â”€ Generic sheet view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="generic-view" style="display:none">
      <div class="panel">
        <div class="panel-header" id="generic-panel-header">×’×™×œ×™×•×Ÿ</div>
        <div id="generic-container">
          <div id="generic-empty">×‘×—×¨ ×¨×©×•×ª ×•×’×™×œ×™×•×Ÿ ×œ×”×¦×’×ª ×”× ×ª×•× ×™×</div>
        </div>
      </div>
    </div>

  </div><!-- /report -->
</main>

<!-- Top/Bottom modal -->
<div id="tb-overlay"></div>
<div id="tb-modal">
  <button id="tb-close" title="×¡×’×•×¨">âœ•</button>
  <div id="tb-title"></div>
  <div id="tb-body"></div>
</div>

<script>
  const muniSearch   = document.getElementById('muni-search');
  const muniSelect   = document.getElementById('muni-select');
  const sheetSelect  = document.getElementById('sheet-select');
  const sheetWrap    = document.getElementById('sheet-wrap');
  const sheetDivider = document.getElementById('sheet-divider');
  const placeholder  = document.getElementById('placeholder');
  const loading      = document.getElementById('loading');
  const report       = document.getElementById('report');
  const form2View    = document.getElementById('form2-view');
  const genericView  = document.getElementById('generic-view');

  let municipalities = [];
  let currentMuni    = null;
  let currentSheet   = 'form2';
  let sheetLabels    = {};   // key â†’ label

  // Load municipalities
  fetch('/api/municipalities')
    .then(r => r.json())
    .then(list => { municipalities = list; rebuildOptions(''); });

  // Load sheet list and populate selector
  fetch('/api/sheets')
    .then(r => r.json())
    .then(sheets => {
      sheets.forEach(s => {
        sheetLabels[s.key] = s.label;
        const opt = document.createElement('option');
        opt.value = s.key; opt.textContent = s.label;
        sheetSelect.appendChild(opt);
      });
    });

  function rebuildOptions(q) {
    const cur = muniSelect.value;
    muniSelect.innerHTML = '<option value="">â€” ×‘×—×¨ ×¨×©×•×ª â€”</option>';
    const filtered = q ? municipalities.filter(m => m.includes(q)) : municipalities;
    filtered.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m; opt.textContent = m;
      muniSelect.appendChild(opt);
    });
    if (cur && filtered.includes(cur)) muniSelect.value = cur;
  }

  muniSearch.addEventListener('input', () => rebuildOptions(muniSearch.value.trim()));

  muniSelect.addEventListener('change', () => {
    const muni = muniSelect.value;
    if (!muni) {
      placeholder.style.display = ''; report.style.display = 'none';
      loading.style.display = 'none';
      sheetWrap.style.display = 'none'; sheetDivider.style.display = 'none';
      return;
    }
    currentMuni = muni;
    sheetWrap.style.display = 'flex'; sheetDivider.style.display = '';
    loadCurrentView();
  });

  sheetSelect.addEventListener('change', () => {
    currentSheet = sheetSelect.value;
    if (currentMuni) loadCurrentView();
  });

  /* â”€â”€ Master loader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function loadCurrentView() {
    if (!currentMuni) return;
    placeholder.style.display = 'none';
    report.style.display = 'none';
    loading.style.display = 'block';

    if (currentSheet === 'form2') {
      fetchForm2(currentMuni);
    } else {
      fetchGenericSheet(currentSheet, currentMuni);
    }
  }

  /* â”€â”€ Form2 (existing logic) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function fetchForm2(muni) {
    fetch(`/api/form2/${encodeURIComponent(muni)}`)
      .then(r => r.json())
      .then(data => {
        loading.style.display = 'none';
        form2View.style.display = '';
        genericView.style.display = 'none';
        renderReport(data);
        report.style.display = 'block';
      })
      .catch(() => {
        loading.style.display = 'none';
        placeholder.textContent = '×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×';
        placeholder.style.display = '';
      });
  }

  /* â”€â”€ Generic sheet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function fetchGenericSheet(sheet, muni) {
    const url = `/api/sheet_data?sheet=${encodeURIComponent(sheet)}&municipality=${encodeURIComponent(muni)}`;
    fetch(url)
      .then(r => r.json())
      .then(data => {
        loading.style.display = 'none';
        form2View.style.display = 'none';
        genericView.style.display = '';
        renderGenericSheet(data);
        report.style.display = 'block';
      })
      .catch(() => {
        loading.style.display = 'none';
        placeholder.textContent = '×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×';
        placeholder.style.display = '';
      });
  }

  // Column header abbreviations (using actual year numbers)
  function abbrevCol(col, yc, yp) {
    const map = {
      '×ª×§×¦×™×‘ ×©× ×” × ×•×›×—×™×ª':            `×ª×§×¦×™×‘ ${yc}`,
      '×‘×™×¦×•×¢ ×©× ×” × ×•×›×—×™×ª':            `×‘×™×¦×•×¢ ${yc}`,
      '×©× ×” × ×•×›×—×™×ª':                  `${yc}`,
      '×ª×§×¦×™×‘ ×©× ×” ×§×•×“××ª':             `×ª×§×¦×™×‘ ${yp}`,
      '×‘×™×¦×•×¢ ×©× ×” ×§×•×“××ª':             `×‘×™×¦×•×¢ ${yp}`,
      '×©× ×” ×§×•×“××ª':                   `${yp}`,
      '××—×•×– ×‘×™×¦×•×¢ ××¡×”×› ×©× ×” × ×•×›×—×™×ª':  `% ××¡×”"×› (${yc})`,
      '××—×•×– ×‘×™×¦×•×¢ ××¡×”×› ×©× ×” ×§×•×“××ª':   `% ××¡×”"×› (${yp})`,
    };
    return map[col] || col;
  }

  function isPercentCol(col) {
    return col.includes('××—×•×–') || col.includes('%');
  }

  function fmtGenericVal(val, col) {
    if (val === null || val === undefined) return null;
    if (isPercentCol(col)) return val.toFixed(1) + '%';
    const abs = Math.abs(val);
    if (abs === 0) return '0';
    if (abs < 10 && !Number.isInteger(val)) return val.toFixed(2);
    if (abs < 1000 && !Number.isInteger(val)) return val.toFixed(1);
    const sign = val < 0 ? 'âˆ’' : '';
    return sign + Math.abs(Math.round(val)).toLocaleString('he-IL');
  }

  function getGenericRowClass(label, row, cols) {
    const lbl = label;
    if (lbl.includes('×¡×”×›') || lbl.includes('×¡×”"×›')) return 'gen-subtotal';
    if (lbl.includes('××—×•×–') || lbl.includes('×™×—×¡ ')) return 'gen-pct-row';
    if (lbl.includes('×¢×•×“×£') || lbl.includes('×’×¨×¢×•×Ÿ')) {
      // Find primary value to determine color
      const prioCols = cols.filter(c => !isPercentCol(c));
      for (const c of prioCols) {
        const v = row[c];
        if (v !== null && v !== undefined) return v >= 0 ? 'gen-result-pos' : 'gen-result-neg';
      }
      return 'gen-result-pos';
    }
    return '';
  }

  function renderGenericSheet(data) {
    const container = document.getElementById('generic-container');
    const panelHeader = document.getElementById('generic-panel-header');

    // Panel title
    const sheetLabel = sheetLabels[data.sheet] || data.sheet || '×’×™×œ×™×•×Ÿ';
    panelHeader.textContent = sheetLabel;

    // Report title
    document.getElementById('report-title-text').textContent =
      `${data.municipality} â€” ${sheetLabel}`;
    document.getElementById('report-subtitle').textContent =
      `× ×ª×•× ×™ ×‘×™×¦×•×¢ | ×©× ×ª ×“×•×— ${data.year_cur} | ×™×—×™×“×•×ª: ××œ×¤×™ ×©"×—`;

    if (!data.rows || data.rows.length === 0) {
      container.innerHTML = '<div id="generic-empty">××™×Ÿ × ×ª×•× ×™× ×œ×¨×©×•×ª ×–×• ×‘×’×™×œ×™×•×Ÿ ×–×”</div>';
      return;
    }

    const cols = data.columns;
    const yc = data.year_cur, yp = data.year_prev;

    // Build table
    let html = '<table class="gen-table"><thead><tr>';
    html += '<th class="gen-th-label">×©×•×¨×”</th>';
    cols.forEach(c => {
      html += `<th class="gen-th-num">${abbrevCol(c, yc, yp)}</th>`;
    });
    html += '</tr></thead><tbody>';

    data.rows.forEach(row => {
      const cls = getGenericRowClass(row.label, row, cols);
      html += `<tr${cls ? ` class="${cls}"` : ''}>`;
      html += `<td class="gen-td-label">${row.label}</td>`;
      cols.forEach(c => {
        const formatted = fmtGenericVal(row[c], c);
        if (formatted === null) {
          html += '<td class="gen-td-null gen-td-num">â€”</td>';
        } else {
          html += `<td class="gen-td-num">${formatted}</td>`;
        }
      });
      html += '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  }

  // â”€â”€ Formatting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function fmtNum(v) {
    if (v === null || v === undefined || v === 0) return 'â€”';
    return Math.round(v).toLocaleString('he-IL');
  }
  function fmtPct(v) {
    if (v === null || v === undefined) return '';
    if (v === 0) return '0.0%';
    return v.toFixed(1) + '%';
  }
  function fmtStat(v) {
    if (v === null || v === undefined) return 'â€”';
    return v.toFixed(1) + '%';
  }
  function numClass(v) {
    if (!v || v === 0) return 'td-val zero';
    if (v < 0) return 'td-val negative';
    return 'td-val';
  }
  function pctClass(v, type) {
    let base = 'td-pct';
    if ((!v || v === 0) && type !== 'grand_total') base += ' zero';
    return base;
  }
  function rankClass(rank, nMusnis) {
    if (!rank || !nMusnis) return 'td-rank zero';
    const pct = rank / nMusnis;
    if (pct <= 0.10) return 'td-rank rank-top';
    if (pct <= 0.25) return 'td-rank rank-high';
    if (pct <= 0.50) return 'td-rank rank-mid';
    return 'td-rank rank-low';
  }

  // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderTable(tbodyId, rows, side) {
    const tbody = document.getElementById(tbodyId);
    tbody.innerHTML = '';
    let nMusnis = 0;

    rows.forEach((row, idx) => {
      const tr = document.createElement('tr');
      tr.className = `row-${row.type}`;
      // mark rows that have sub_row children following them (only non-sub_rows)
      if (row.type !== 'sub_row' && rows[idx + 1] && rows[idx + 1].type === 'sub_row') {
        tr.classList.add('has-children');
      }

      if (row.type === 'section_header') {
        // colspan = 9 total columns - 1 (td-num) = 8
        tr.innerHTML = `<td class="td-num">${row.num}</td><td colspan="8" class="td-label">${row.label}</td>`;
      } else {
        const cv = row.cur_val  ?? 0;
        const pv = row.prev_val ?? 0;
        const cp = row.cur_pct;
        const pp = row.prev_pct;
        const ap = row.avg_pct;
        const mp = row.median_pct;
        const rk = row.rank;
        const nm = row.n_munis;
        if (nm) nMusnis = nm;

        const rankStr = (rk && row.type !== 'grand_total') ? `${rk}` : 'â€”';
        tr.innerHTML = `
          <td class="td-num">${row.num}</td>
          <td class="td-label">${row.label}</td>
          <td class="${numClass(cv)} td-group-sep">${fmtNum(cv)}</td>
          <td class="${pctClass(cp, row.type)}">${fmtPct(cp)}</td>
          <td class="${numClass(pv)} td-group-sep">${fmtNum(pv)}</td>
          <td class="${pctClass(pp, row.type)}">${fmtPct(pp)}</td>
          <td class="td-stat td-group-sep">${fmtStat(ap)}</td>
          <td class="td-stat">${fmtStat(mp)}</td>
          <td class="${rankClass(rk, nm)}">${rankStr}</td>
        `;

        // Make clickable if it has a key and is not grand_total
        if (row.key && row.type !== 'grand_total') {
          tr.classList.add('row-clickable');
          tr.addEventListener('click', () => openTB(row, side));
        }
      }
      tbody.appendChild(tr);
    });
    return nMusnis;
  }

  function renderReport(data) {
    document.getElementById('report-title-text').textContent =
      `${data.municipality} â€” ×˜×•×¤×¡ ××¡×³ 2`;
    // Restore form2 subtitle
    document.getElementById('report-subtitle').innerHTML =
      `× ×ª×•× ×™ ×‘×™×¦×•×¢ | ×©× ×ª ×“×•×— <span id="year-cur-label">${data.year_cur}</span> | ×™×—×™×“×•×ª: ××œ×¤×™ ×©"×— | ×“×™×¨×•×’ ××ª×•×š <span id="n-munis">â€”</span> ×¨×©×•×™×•×ª`;
    // Update year labels everywhere
    document.querySelectorAll('.hdr-cur').forEach(el => el.textContent = data.year_cur);
    document.querySelectorAll('.hdr-prev').forEach(el => el.textContent = data.year_prev);
    const n = renderTable('tbody-receipts', data.receipts, 'receipts');
    renderTable('tbody-payments', data.payments, 'payments');
    if (n) document.getElementById('n-munis').textContent = n;
    renderBalance(data.balance, data.year_cur, data.year_prev);
  }

  function renderBalance(b, yearCur, yearPrev) {
    document.getElementById('balance-bar').style.display = '';

    function fmt(v) {
      if (v === null || v === undefined) return 'â€”';
      const abs = Math.abs(Math.round(v));
      const sign = v < 0 ? 'âˆ’' : '';
      return sign + abs.toLocaleString('he-IL');
    }

    function setCell(id, v, colored) {
      const el = document.getElementById(id);
      el.textContent = fmt(v);
      if (colored) {
        el.className = 'bal-num' + (v > 0 ? ' bal-positive' : v < 0 ? ' bal-negative' : '');
      }
    }

    setCell('bal-rec-cur',      b.rec_cur,      false);
    setCell('bal-rec-prev',     b.rec_prev,     false);
    setCell('bal-pay-cur',      b.pay_cur,      false);
    setCell('bal-pay-prev',     b.pay_prev,     false);
    setCell('bal-surplus-cur',  b.surplus_cur,  true);
    setCell('bal-surplus-prev', b.surplus_prev, true);

    document.getElementById('bal-result-row').className =
      b.surplus_cur < 0 ? 'bal-deficit' : 'bal-result';
  }

  // â”€â”€ Top / Bottom modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const tbOverlay = document.getElementById('tb-overlay');
  const tbModal   = document.getElementById('tb-modal');
  const tbClose   = document.getElementById('tb-close');
  const tbTitle   = document.getElementById('tb-title');
  const tbBody    = document.getElementById('tb-body');

  function openTB(row, side) {
    tbTitle.textContent = row.label;
    tbBody.innerHTML = '<div style="text-align:center;padding:24px;color:#94a3b8;">×˜×•×¢×Ÿ...</div>';
    tbOverlay.classList.add('open');
    tbModal.classList.add('open');

    fetch(`/api/topbottom/${side}/${encodeURIComponent(row.key)}`)
      .then(r => r.json())
      .then(data => { tbBody.innerHTML = renderTBBody(data); })
      .catch(() => {
        tbBody.innerHTML = '<div style="color:#dc2626;text-align:center;padding:12px;">×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×</div>';
      });
  }

  function renderTBBody(data) {
    function makeTable(items) {
      if (!items || !items.length)
        return '<div style="color:#94a3b8;font-size:0.8rem;padding:4px 12px;">××™×Ÿ × ×ª×•× ×™×</div>';
      const rows = items.map((item, i) => `
        <tr>
          <td class="td-r">${i + 1}</td>
          <td>${item.muni}</td>
          <td class="td-pct">${item.pct.toFixed(1)}%</td>
        </tr>`).join('');
      return `
        <table class="tb-table">
          <thead><tr>
            <th class="td-r">#</th>
            <th>×¨×©×•×ª ××§×•××™×ª</th>
            <th class="td-pct">%</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    const zeroBlock = data.n_zero > 0 ? `
      <button class="tb-zero-btn" onclick="toggleZeros(this)">
        âšª ×”×¦×’ ${data.n_zero} ×¨×©×•×™×•×ª ×¢× ×¢×¨×š ××¤×¡ â–¾
      </button>
      <div class="tb-zero-section">
        <ul class="tb-zero-list">
          ${data.zeros.map(m => `<li>${m}</li>`).join('')}
        </ul>
      </div>` : '';

    return `
      <div class="tb-section tb-top">
        <div class="tb-subtitle">ğŸ† 5 ×”×¨×©×•×™×•×ª ×¢× ×”×©×™×¢×•×¨ ×”×’×‘×•×” ×‘×™×•×ª×¨</div>
        ${makeTable(data.top5)}
      </div>
      <div class="tb-section tb-bot">
        <div class="tb-subtitle">ğŸ“‰ 5 ×”×¨×©×•×™×•×ª ×¢× ×”×©×™×¢×•×¨ ×”× ××•×š ×‘×™×•×ª×¨</div>
        ${makeTable(data.bottom5)}
      </div>
      <div class="tb-footer">
        ×¡×”"×› ${data.total} ×¨×©×•×™×•×ª${data.n_zero > 0 ? ` | ${data.n_zero} ×¢× ×¢×¨×š ××¤×¡` : ''}
        ${zeroBlock}
      </div>
    `;
  }

  function toggleZeros(btn) {
    const section = btn.nextElementSibling;
    const isOpen = section.classList.toggle('open');
    btn.textContent = isOpen
      ? `âšª ×”×¡×ª×¨ ×¨×©×•×™×•×ª ×¢× ×¢×¨×š ××¤×¡ â–´`
      : `âšª ×”×¦×’ ${section.querySelectorAll('li').length} ×¨×©×•×™×•×ª ×¢× ×¢×¨×š ××¤×¡ â–¾`;
  }

  function closeTB() {
    tbOverlay.classList.remove('open');
    tbModal.classList.remove('open');
  }

  tbClose.addEventListener('click', closeTB);
  tbOverlay.addEventListener('click', closeTB);
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeTB(); });
</script>
</body>
</html>
